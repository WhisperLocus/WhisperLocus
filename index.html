<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="utf-8">
    <title>WhisperLocus</title>
    <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no">

    <script src='https://api.mapbox.com/mapbox-gl-js/v3.4.0/mapbox-gl.js'></script>
    <link href='https://api.mapbox.com/mapbox-gl-js/v3.4.0/mapbox-gl.css' rel='stylesheet' />
    <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@600&display=swap" rel="stylesheet">
    
<style>
/* ---------------------------------------------------- */
/* 基礎佈局 */
/* ---------------------------------------------------- */
*, ::before, ::after { box-sizing: border-box; }

html, body {
    margin: 0;
    padding: 0;
    width: 100%;
    height: 100vh;
    overflow: hidden; 
    background-color: #f0f0f0;
}

#map-container {
    position: absolute;
    top: 0;
    bottom: 0;
    width: 100%;
    z-index: 1;
}

/* ---------------------------------------------------- */
/* 頂部導覽列配置 (置中 Logo + 兩側圖示) */
/* ---------------------------------------------------- */
#top-navigation {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100px;
    z-index: 100;
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 0 40px;
    pointer-events: none; /* 穿透點擊到地圖 */
}

#top-navigation > * {
    pointer-events: auto; /* 恢復按鈕點擊 */
}

/* 左側：三條橫線 Logo (About) */
.nav-icon-left {
    background: none;
    border: none;
    cursor: pointer;
    display: flex;
    flex-direction: column;
    gap: 6px;
    padding: 10px;
}

.nav-icon-left span {
    display: block;
    width: 22px;
    height: 1.2px;
    background-color: #333;
    transition: 0.3s;
}

/* 中間：Logo 與 副標 */
#branding-center {
    text-align: center;
}

#main-logo {
    font-family: 'Cormorant Garamond', serif;
    font-size: 32px;
    font-weight: 600; 
    color: #333;
    margin: 0;
    line-height: 1;
    letter-spacing: 1px;
}

#sub-slogan {
    font-family: 'Arial', sans-serif;
    font-size: 11px;
    color: #888;
    margin: 8px 0 0 0;
    letter-spacing: 0.5px;
}

/* 右側：六個小圓點 Logo (Actions) */
.nav-icon-right {
    background: none;
    border: none;
    cursor: pointer;
    display: grid;
    grid-template-columns: repeat(3, 4px);
    gap: 4px;
    padding: 10px;
}

.nav-icon-right span {
    display: block;
    width: 4px;
    height: 4px;
    background-color: #333;
    border-radius: 50%;
}

/* ---------------------------------------------------- */
/* 右側功能面板 (Leave & Search) */
/* ---------------------------------------------------- */
#actions-panel {
    position: fixed;
    top: 90px;
    right: 40px;
    width: 250px;
    background: rgba(255, 255, 255, 0.8);
    backdrop-filter: blur(15px);
    -webkit-backdrop-filter: blur(15px);
    padding: 20px;
    border-radius: 12px;
    box-shadow: 0 10px 30px rgba(0,0,0,0.05);
    z-index: 150;
    transform: translateY(-10px);
    opacity: 0;
    visibility: hidden;
    transition: all 0.4s cubic-bezier(0.165, 0.84, 0.44, 1);
}

#actions-panel.show {
    transform: translateY(0);
    opacity: 1;
    visibility: visible;
}

#leave-post-link {
    display: block;
    width: 100%;
    background-color: #333; 
    color: white; 
    text-decoration: none;
    padding: 12px; 
    border-radius: 6px;
    font-size: 13px;
    text-align: center;
    margin-bottom: 15px;
    transition: background 0.2s;
}

#leave-post-link:hover { background-color: #000; }

#code-input {
    width: 100%; 
    padding: 12px; 
    font-size: 13px;
    border-radius: 6px; 
    border: 1px solid rgba(0,0,0,0.1); 
    background: white; 
    text-align: center;
    outline: none;
}

#code-search-message {
    font-size: 11px; 
    color: #ff5722;
    margin-top: 10px;
    text-align: center;
    min-height: 15px;
}

/* ---------------------------------------------------- */
/* About 說明面板樣式 */
/* ---------------------------------------------------- */
#about-panel {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(255, 255, 255, 0.9);
    backdrop-filter: blur(15px);
    -webkit-backdrop-filter: blur(15px);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 2000;
    opacity: 0;
    visibility: hidden;
    transition: opacity 0.5s ease;
}

#about-panel.show {
    opacity: 1;
    visibility: visible;
}

.about-content {
    position: relative;
    max-width: 600px;
    width: 85%;
    text-align: center;
    color: #333;
    font-family: 'Arial', sans-serif;
    line-height: 1.8;
}

#about-close {
    position: absolute;
    top: -60px;
    right: 0;
    background: none;
    border: none;
    font-size: 32px;
    cursor: pointer;
    color: #999;
}

.about-highlight { margin-top: 30px; font-style: italic; font-weight: bold; }

/* 響應式微調 */
@media (max-width: 480px) {
    #top-navigation { padding: 0 20px; height: 80px; }
    #main-logo { font-size: 26px; }
    #actions-panel { right: 20px; width: calc(100% - 40px); }
}

/* Popup 樣式 (保留你原本設定) */
.custom-memo-popup .mapboxgl-popup-content { background-color: #FFFEF9 !important; border-radius: 2px !important; box-shadow: 5px 5px 15px rgba(0, 0, 0, 0.2) !important; padding: 0 !important; width: 300px !important; min-height: 250px !important; display: flex; flex-direction: column; }
.emotion-popup-content-wrapper { padding: 35px 20px 40px 25px; flex-grow: 1; display: flex; flex-direction: column; position: relative; }
.memo-content-text { font-size: 15px; line-height: 1.7; color: #333; white-space: pre-wrap; word-break: break-word; margin: 10px 0; overflow-y: auto; max-height: 180px; flex-grow: 1; display: flex; flex-direction: column; justify-content: center; }
.memo-content-text::before, .memo-content-text::after { content: ""; flex-grow: 1; }
.popup-code-label, .popup-delete-btn, .popup-location-label, .popup-bottom-right { font-size: 11px; color: #999; position: absolute; font-family: Arial, sans-serif; }
.popup-code-label { top: 10px; left: 15px; }
.popup-delete-btn { top: 10px; right: 15px; cursor: pointer; }
.popup-location-label { bottom: 10px; left: 15px; color: #777; }
.popup-bottom-right { bottom: 10px; right: 15px; }

</style>
</head>

<body>
    <div id="map-container"></div> 
    
    <nav id="top-navigation">
        <button class="nav-icon-left" id="btn-about-trigger" title="About Us">
            <span></span><span></span><span></span>
        </button>

        <div id="branding-center">
            <h1 id="main-logo">WhisperLocus</h1>
            <p id="sub-slogan">For the words we never got to say.</p>
        </div>

        <button class="nav-icon-right" id="btn-actions-trigger" title="Menu">
            <span></span><span></span><span></span>
            <span></span><span></span><span></span>
        </button>
    </nav>

    <div id="actions-panel">
        <a href="post.html" id="leave-post-link">Leave a whisper.</a>
        <form id="code-search-form">
            <input type="text" id="code-input" placeholder="Search by Code" maxlength="8" required autocomplete="off">
            <div id="code-search-message"></div>
        </form>
    </div>

    <div id="about-panel">
        <div class="about-content">
            <button id="about-close" title="Close">&times;</button>
            <div id="about-text-container"></div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
        import { getFirestore, collection, getDocs, doc, deleteDoc, query, where, serverTimestamp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDFED1K3dpMYaUpj8DlJWI1SnqgfFWzy44",
            authDomain: "whisperlocus.firebaseapp.com",
            projectId: "whisperlocus",
            storageBucket: "whisperlocus.firebasestorage.app",
            messagingSenderId: "801292984890",
            appId: "1:801292984890:web:0c064b4c206a8000f84b03",
            measurementId: "G-TCB2PWSN1C"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        window.db = db; window.collection = collection; window.getDocs = getDocs; window.doc = doc; window.deleteDoc = deleteDoc; window.query = query; window.where = where; window.serverTimestamp = serverTimestamp;
    </script>

    <script src="map.js"></script>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- 1. 多國語言內容 ---
            const translations = {
                'zh': `<p>WhisperLocus 是一個公開的匿名地圖。</p><p>它為那些未曾找到合適時機說出口的<br>思緒、記憶與情感而存在。</p><p>每一則貼文都是匿名的，公開的。<br>它們錨定於特定的空間。</p><p class="about-highlight">你可以不在這裡留下任何東西，<br>僅僅只是瀏覽也是沒問題的。</p>`,
                'en': `<p>WhisperLocus is a public, anonymous map.</p><p>It exists for thoughts, memories, and feelings<br>that never found the right moment to be spoken.</p><p class="about-highlight">You don’t have to leave anything here.<br>You’re allowed to just look.</p>`
            };

            const userLang = navigator.language || navigator.userLanguage;
            document.getElementById('about-text-container').innerHTML = translations[userLang.startsWith('zh') ? 'zh' : 'en'];

            // --- 2. 交互控制邏輯 ---
            const btnAbout = document.getElementById('btn-about-trigger');
            const aboutPanel = document.getElementById('about-panel');
            const aboutClose = document.getElementById('about-close');
            
            const btnActions = document.getElementById('btn-actions-trigger');
            const actionsPanel = document.getElementById('actions-panel');

            // 顯示 About
            btnAbout.addEventListener('click', () => {
                aboutPanel.classList.add('show');
                actionsPanel.classList.remove('show');
            });

            // 關閉 About
            aboutClose.addEventListener('click', () => aboutPanel.classList.remove('show'));
            aboutPanel.addEventListener('click', (e) => { if(e.target === aboutPanel) aboutPanel.classList.remove('show'); });

            // 切換右側功能選單
            btnActions.addEventListener('click', (e) => {
                e.stopPropagation();
                actionsPanel.classList.toggle('show');
            });

            // 點擊頁面其他地方關閉功能面板
            document.addEventListener('click', (e) => {
                if (!actionsPanel.contains(e.target) && e.target !== btnActions) {
                    actionsPanel.classList.remove('show');
                }
            });

            // --- 3. 搜尋訊息處理 ---
            const msgBox = document.getElementById('code-search-message');
            const urlParams = new URLSearchParams(window.location.search);
            const code = urlParams.get('code');
            if (code) {
                msgBox.textContent = `找到貼文 "${code}"`;
                setTimeout(() => { msgBox.textContent = ""; }, 4000);
            }
        });
    </script>
</body>
</html>