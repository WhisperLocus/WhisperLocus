<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="utf-8">
    <title>WhisperLocus</title>
    <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no">

    <script src='https://api.mapbox.com/mapbox-gl-js/v3.4.0/mapbox-gl.js'></script>
    <link href='https://api.mapbox.com/mapbox-gl-js/v3.4.0/mapbox-gl.css' rel='stylesheet' />
    
    <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@600&display=swap" rel="stylesheet">
    
<style>
/* ---------------------------------------------------- */
/* åŸºç¤ä½ˆå±€ */
/* ---------------------------------------------------- */
*, ::before, ::after { box-sizing: border-box; }

html, body {
    margin: 0;
    padding: 0;
    width: 100%;
    height: 100vh;
    overflow: hidden; /* é˜²æ­¢åœ°åœ–å‡ºç¾å¤–éƒ¨æ²è»¸ */
    background-color: #f0f0f0;
}

#map-container {
    position: absolute;
    top: 0;
    bottom: 0;
    width: 100%;
    z-index: 1;
}

/* ---------------------------------------------------- */
/* å·¦ä¸Šè§’æ§åˆ¶é¢æ¿ */
/* ---------------------------------------------------- */
#left-top-controls {
    position: absolute;
    z-index: 10; 
    top: 20px; 
    left: 20px; 
    width: 240px; 
    max-width: 90%;
    pointer-events: none; /* ç©¿é€åˆ°åœ°åœ–ï¼Œé™¤éæ˜¯å­å…ƒç´  */
}

#left-top-controls > * {
    pointer-events: auto; /* è®“æŒ‰éˆ•å’Œè¼¸å…¥æ¡†å¯é»æ“Š */
}

#logo-header {
    margin-bottom: 20px;
    text-shadow: 0 0 10px rgba(255,255,255,0.8);
}

#main-logo {
    font-family: 'Cormorant Garamond', serif;
    font-size: 36px;
    font-weight: 600; 
    color: #333;
    margin: 0;
    line-height: 1;
}

#sub-slogan {
    font-family: 'Arial', sans-serif;
    font-size: 15px;
    color: #666;
    margin: 5px 0 0 0;
}

/* æ§åˆ¶é …æ¨£å¼ */
#leave-post-link {
    display: block;
    width: 100%;
    background-color: #ff5722; 
    color: white; 
    text-decoration: none;
    padding: 12px; 
    border-radius: 8px;
    font-weight: Regular; 
    text-align: center;
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.15);
    margin-bottom: 12px;
    transition: transform 0.2s, background-color 0.2s;
}

#leave-post-link:hover {
    background-color: #e64a19;
    transform: translateY(-2px);
}

#code-search-form {
    width: 100%;
}

#code-input {
    width: 100%; 
    padding: 12px; 
    font-size: 14px;
    border-radius: 8px; 
    border: 1px solid rgba(0,0,0,0.1); 
    background: white; 
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1); 
    text-align: center;
    outline: none;
}

#code-search-message {
    font-size: 12px; 
    color: #ff5722;
    margin-top: 8px;
    text-align: center;
    font-weight: bold;
    min-height: 18px;
    /* ğŸ¯ åŠ å…¥æ¼¸è®Šæ•ˆæœè®“æ¶ˆå¤±æ›´è‡ªç„¶ */
    transition: opacity 0.8s ease;
    opacity: 1;
}

/* ---------------------------------------------------- */
/* ğŸ¯ Popup ä¾¿åˆ©è²¼æ¨£å¼ (å°æ‡‰ map.js) */
/* ---------------------------------------------------- */
.custom-memo-popup .mapboxgl-popup-content {
    background-color: #FFFEF9 !important; /* ä¾¿åˆ©è²¼ç±³ç™½ */
    border-radius: 2px !important;
    box-shadow: 5px 5px 15px rgba(0, 0, 0, 0.2) !important;
    padding: 0 !important;
    width: 300px !important; /* æ¡Œé¢ç«¯å¯¬åº¦ */
    min-height: 250px !important;
    display: flex;
    flex-direction: column;
}

/* ç§»å‹•ç«¯å¯¬åº¦èª¿æ•´ */
@media (max-width: 480px) {
    .custom-memo-popup .mapboxgl-popup-content {
        width: 80vw !important;
    }
}

.emotion-popup-content-wrapper {
    padding: 35px 20px 40px 25px;
    flex-grow: 1;
    display: flex;
    flex-direction: column;
    position: relative;
    height: 100%;
}

/* çŸ­æ–‡ç½®ä¸­æ¨¡å¼ (ç”± map.js å‹•æ…‹åŠ å…¥) */
.mapboxgl-popup-content.is-centered-text .memo-content-text {
    display: flex !important;
    align-items: center !important;
    justify-content: center !important;
    text-align: center !important;
    margin: auto !important;
    font-size: 18px !important;
    line-height: 1.6;
}

/* é•·æ–‡ä¸€èˆ¬æ¨¡å¼ */
.memo-content-text {
    font-size: 15px;
    line-height: 1.7;
    color: #333;
    white-space: pre-wrap;
    word-break: break-word;
    margin: 10px 0;
    overflow-y: auto;
    max-height: 200px;
}

/* è£é£¾æ–‡å­— */
.popup-code-label { position: absolute; top: 10px; left: 15px; font-size: 11px; color: #999; font-family: Arial, sans-serif; }
.popup-location-label { position: absolute; bottom: 10px; left: 15px; font-size: 11px; color: #777; font-family: Arial, sans-serif; }
.popup-bottom-right { position: absolute; bottom: 10px; right: 15px; font-size: 11px; color: #999; font-family: Arial, sans-serif;}

/* åˆªé™¤æŒ‰éˆ• */
.popup-delete-btn {
    position: absolute;
    top: 8px;
    right: 8px;
    background: none;
    border: 1px solid;
    border-radius: 4px;
    padding: 2px 6px;
    font-size: 10px;
    cursor: pointer;
    opacity: 0.6;
    transition: opacity 0.2s;
}
.popup-delete-btn:hover { opacity: 1; }

</style>
</head>

<body>
    <div id="map-container"></div> 
    
    <div id="left-top-controls">
        <div id="logo-header">
            <h1 id="main-logo">WhisperLocus</h1>
            <p id="sub-slogan">For the words we never got to say.</p>
        </div>

        <a href="post.html" id="leave-post-link">
            Leave a whisper.
        </a>
        
        <form id="code-search-form">
            <input type="text" id="code-input" placeholder="Search by Code" maxlength="8" required autocomplete="off">
            <div id="code-search-message"></div>
        </form>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
        import { 
            getFirestore, 
            collection, 
            getDocs, 
            doc, 
            deleteDoc, 
            query, 
            where, 
            serverTimestamp 
        } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDFED1K3dpMYaUpj8DlJWI1SnqgfFWzy44",
            authDomain: "whisperlocus.firebaseapp.com",
            projectId: "whisperlocus",
            storageBucket: "whisperlocus.firebasestorage.app",
            messagingSenderId: "801292984890",
            appId: "1:801292984890:web:0c064b4c206a8000f84b03",
            measurementId: "G-TCB2PWSN1C"
        };

        // åˆå§‹åŒ– Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
      
        // å°‡å¿…è¦çš„ Firebase å·¥å…·æ›è¼‰åˆ° windowï¼Œä¾› map.js ä½¿ç”¨
        window.db = db;
        window.collection = collection;
        window.getDocs = getDocs;
        window.doc = doc;
        window.deleteDoc = deleteDoc;
        window.query = query;
        window.where = where;
        window.serverTimestamp = serverTimestamp;

        console.log("ğŸ”¥ Firebase Ready for Map Operations");
    </script>

    <script src="map.js"></script>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const msgBox = document.getElementById('code-search-message');
            let hideTimeout = null;

            // æ ¸å¿ƒåŠŸèƒ½ï¼šåŸ·è¡Œéš±è—å‹•ç•«
            const startHideTimer = () => {
                // å¦‚æœæ–‡å­—æ˜¯ç©ºçš„å°±ä¸åŸ·è¡Œ
                if (msgBox.textContent.trim() === "") return;

                // æ¸…é™¤ä¹‹å‰çš„è¨ˆæ™‚å™¨ï¼Œé¿å…å¤šæ¬¡è§¸ç™¼è¡çª
                if (hideTimeout) clearTimeout(hideTimeout);

                // 4 ç§’å¾Œé–‹å§‹æ·¡å‡º
                hideTimeout = setTimeout(() => {
                    msgBox.style.opacity = "0";
                    
                    // ç­‰æ·¡å‡ºå‹•ç•«çµæŸ (800ms) å¾Œæ¸…ç©ºæ–‡å­—ä¸¦æ¢å¾©é€æ˜åº¦ï¼Œç‚ºä¸‹æ¬¡é¡¯ç¤ºåšæº–å‚™
                    setTimeout(() => {
                        msgBox.textContent = "";
                        msgBox.style.opacity = "1";
                    }, 800);
                }, 4000);
            };

            // 1. è™•ç† URL å¸¶ä¾†çš„ code (ç™¼ä½ˆæˆåŠŸè·³è½‰æ™‚)
            const urlParams = new URLSearchParams(window.location.search);
            const code = urlParams.get('code');
            if (code) {
                msgBox.textContent = `æ‰¾åˆ°è²¼æ–‡ "${code}"`;
                startHideTimer();
            }

            // 2. ç›£è½ `#code-search-message` çš„è®ŠåŒ– (è™•ç†ç”± map.js ç”¢ç”Ÿçš„æœå°‹çµæœ)
            const observer = new MutationObserver(() => {
                if (msgBox.textContent.trim() !== "") {
                    msgBox.style.opacity = "1"; // ç¢ºä¿æ–‡å­—è®Šæ›´æ™‚æ˜¯å¯è¦‹çš„
                    startHideTimer();
                }
            });

            observer.observe(msgBox, { childList: true, characterData: true, subtree: true });
        });
    </script>

</body>
</html>