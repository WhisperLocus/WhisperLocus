<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="utf-8">
    <title>WhisperLocus</title>
    <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no">

    <script src='https://api.mapbox.com/mapbox-gl-js/v3.4.0/mapbox-gl.js'></script>
    <link href='https://api.mapbox.com/mapbox-gl-js/v3.4.0/mapbox-gl.css' rel='stylesheet' />
    <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@600&display=swap" rel="stylesheet">
    
<style>
/* ---------------------------------------------------- */
/* 基礎佈局 */
/* ---------------------------------------------------- */
*, ::before, ::after { box-sizing: border-box; }

html, body {
    margin: 0;
    padding: 0;
    width: 100%;
    height: 100vh;
    overflow: hidden; 
    background-color: #f0f0f0;
}

#map-container {
    position: absolute;
    top: 0;
    bottom: 0;
    width: 100%;
    z-index: 1;
}

/* ---------------------------------------------------- */
/* 頂部導覽列配置 (置中 Logo + 兩側圖示) */
/* ---------------------------------------------------- */
#top-navigation {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100px;
    z-index: 100;
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 0 40px;
    pointer-events: none; /* 穿透點擊到地圖 */
}

#top-navigation > * {
    pointer-events: auto; /* 恢復按鈕點擊 */
}

/* 左側：三條橫線 Logo (About) */
.nav-icon-left {
    background: none;
    border: none;
    cursor: pointer;
    display: flex;
    flex-direction: column;
    gap: 6px;
    padding: 10px;
}

.nav-icon-left span {
    display: block;
    width: 22px;
    height: 1.2px;
    background-color: #333;
    transition: 0.3s;
}

/* 中間：Logo 與 副標 */
#branding-center {
    text-align: center;
}

#main-logo {
    font-family: 'Cormorant Garamond', serif;
    font-size: 32px;
    font-weight: 600; 
    color: #333;
    margin: 0;
    line-height: 1;
    letter-spacing: 1px;
}

#sub-slogan {
    font-family: 'Arial', sans-serif;
    font-size: 11px;
    color: #555;
    margin: 4px 0 0 0;
    letter-spacing: 0.5px;
}

/* 右側：六個小圓點 Logo (Actions) */
.nav-icon-right {
    background: none;
    border: none;
    cursor: pointer;
    display: grid;
    grid-template-columns: repeat(3, 4px);
    gap: 4px;
    padding: 10px;
}

.nav-icon-right span {
    display: block;
    width: 4px;
    height: 4px;
    background-color: #333;
    border-radius: 50%;
}

/* ---------------------------------------------------- */
/* 右側功能面板 (Leave & Search) */
/* ---------------------------------------------------- */
#actions-panel {
    position: fixed;
    top: 90px;
    right: 40px;
    width: 250px;
    height: 140px;
    background: rgba(255, 255, 255, 0.8);
    backdrop-filter: blur(15px);
    -webkit-backdrop-filter: blur(15px);
    padding: 20px;
    border-radius: 12px;
    box-shadow: 0 10px 30px rgba(0,0,0,0.05);
    z-index: 150;
    transform: translateY(-10px);
    opacity: 0;
    visibility: hidden;
    transition: all 0.4s cubic-bezier(0.165, 0.84, 0.44, 1);
}

#actions-panel.show {
    transform: translateY(0);
    opacity: 1;
    visibility: visible;
}

#leave-post-link {
    display: block;
    width: 100%;
    background-color: #ff5722; 
    color: white; 
    text-decoration: none;
    padding: 12px; 
    border-radius: 6px;
    font-size: 13px;
    text-align: center;
    margin-bottom: 15px;
    transition: background 0.2s;
}

#leave-post-link:hover { background-color: #ff5722; }

#code-input {
    width: 100%; 
    padding: 12px; 
    font-size: 13px;
    border-radius: 6px; 
    border: 1px solid rgba(0,0,0,0.1); 
    background: white; 
    text-align: center;
    outline: none;
}

#code-search-message {
    font-size: 11px; 
    color: #ff5722;
    margin-top: 10px;
    text-align: center;
    min-height: 15px;
}

/* ---------------------------------------------------- */
/* About 說明面板樣式 */
/* ---------------------------------------------------- */
#about-panel {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(255, 255, 255, 0.9);
    backdrop-filter: blur(1px);
    -webkit-backdrop-filter: blur(1px);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 2000;
    opacity: 0;
    visibility: hidden;
    transition: opacity 0.5s ease;
}

#about-panel.show {
    opacity: 1;
    visibility: visible;
}

.about-content {
    position: relative;
    max-width: 600px;
    width: 85%;
    text-align: center;
    color: #333;
    font-family: 'Arial', sans-serif;
    line-height: 1.8;
}

#about-close {
    position: absolute;
    top: -60px;
    right: 0;
    background: none;
    border: none;
    font-size: 32px;
    cursor: pointer;
    color: #999;
}

.about-highlight { margin-top: 30px; font-style: italic; font-weight: bold; }

/* 響應式微調 */
@media (max-width: 480px) {
    #top-navigation { padding: 0 20px; height: 80px; }
    #main-logo { font-size: 26px; }
    #actions-panel { right: 20px; width: calc(100% - 40px); }
}

/* Popup 樣式 (保留你原本設定) */
.custom-memo-popup .mapboxgl-popup-content { background-color: #FFFEF9 !important; border-radius: 2px !important; box-shadow: 5px 5px 15px rgba(0, 0, 0, 0.2) !important; padding: 0 !important; width: 300px !important; min-height: 250px !important; display: flex; flex-direction: column; }
.emotion-popup-content-wrapper { padding: 35px 20px 40px 25px; flex-grow: 1; display: flex; flex-direction: column; position: relative; }
.memo-content-text { font-size: 15px; line-height: 1.7; color: #333; white-space: pre-wrap; word-break: break-word; margin: 10px 0; overflow-y: auto; max-height: 180px; flex-grow: 1; display: flex; flex-direction: column; justify-content: center; }
.memo-content-text::before, .memo-content-text::after { content: ""; flex-grow: 1; }
.popup-code-label, .popup-delete-btn, .popup-location-label, .popup-bottom-right { font-size: 11px; color: #999; position: absolute; font-family: Arial, sans-serif; }
.popup-code-label { top: 10px; left: 15px; }
.popup-delete-btn { top: 10px; right: 15px; cursor: pointer; }
.popup-location-label { bottom: 10px; left: 15px; color: #777; }
.popup-bottom-right { bottom: 10px; right: 15px; }

</style>
</head>

<body>
    <div id="map-container"></div> 
    
    <nav id="top-navigation">
        <button class="nav-icon-left" id="btn-about-trigger" title="About Us">
            <span></span><span></span><span></span>
        </button>

        <div id="branding-center">
            <h1 id="main-logo">WhisperLocus</h1>
            <p id="sub-slogan">For the words we never got to say.</p>
        </div>

        <button class="nav-icon-right" id="btn-actions-trigger" title="Menu">
            <span></span><span></span><span></span>
            <span></span><span></span><span></span>
        </button>
    </nav>

    <div id="actions-panel">
        <a href="post.html" id="leave-post-link">Leave a whisper.</a>
        <form id="code-search-form">
            <input type="text" id="code-input" placeholder="Search by Code" maxlength="8" required autocomplete="off">
            <div id="code-search-message"></div>
        </form>
    </div>

    <div id="about-panel">
        <div class="about-content">
            <button id="about-close" title="Close">&times;</button>
            <div id="about-text-container"></div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
        import { getFirestore, collection, getDocs, doc, deleteDoc, query, where, serverTimestamp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDFED1K3dpMYaUpj8DlJWI1SnqgfFWzy44",
            authDomain: "whisperlocus.firebaseapp.com",
            projectId: "whisperlocus",
            storageBucket: "whisperlocus.firebasestorage.app",
            messagingSenderId: "801292984890",
            appId: "1:801292984890:web:0c064b4c206a8000f84b03",
            measurementId: "G-TCB2PWSN1C"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        window.db = db; window.collection = collection; window.getDocs = getDocs; window.doc = doc; window.deleteDoc = deleteDoc; window.query = query; window.where = where; window.serverTimestamp = serverTimestamp;
    </script>

    <script src="map.js"></script>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- 1. 多國語言內容 ---
            const translations = {
                'zh': `
                    <p>WhisperLocus 是一個公開的匿名地圖。
                    <p>它為那些未曾找到合適時機說出口的<br>思緒、記憶與情感而存在。</p>
                    <p>每一則貼文都是匿名的，<br>每一則貼文都是公開的。<br>它們錨定於特定的空間，<br>僅由唯一的代碼標記。</p>
                    <p>這裡沒有個人檔案、沒有評論，也沒有回覆。
                    <p>若貼文包含針對性的傷害、<br>露骨廣告或刻意濫用，<br>可能會被審核或移除。<br>審核的存在是為了守護這片寧靜。</p>
                    <p class="about-highlight">你可以不在這裡留下任何東西，<br>僅僅只是瀏覽也是沒問題的。</p>
                `,
                'en': `
                    <p>WhisperLocus is a public, anonymous map<br>where words are placed, not exchanged.</p>
                    <p>It exists for those <br>thoughts, memories and emotions that have never found the right time to express them. </p>
                    <p>Every post is anonymous,<br>Every post is public. <br>They are anchored to a specific space,<br>marked only by a unique code. </p>
                    <p>There are no profiles, no comments, and no replies.</p>
                    <p>Posts that contain targeted harm, <br>explicit advertising, or are intentionally abusive<br> may be reviewed or removed. 
                    <br>The audit exists to protect this tranquility. </p>
                    <p class="about-highlight">You don't have to leave anything here,<br> just browsing is fine. </p>
                `
                ,
                'fr': `
                    <p>WhisperLocus est une carte publique et anonyme<br>où les mots sont placés et non échangés.</p> 
                    <p>Il existe pour ces pensées, souvenirs et émotions qui n'ont jamais trouvé le bon moment pour les exprimer. </p> 
                    <p>Chaque publication est anonyme,<br>Chaque publication est publique. <br>Ils sont ancrés dans un espace spécifique,<br>marqué uniquement par un code unique. </p> 
                    <p>Il n'y a aucun profil, aucun commentaire et aucune réponse.</p> 
                    <p>Les messages contenant des préjudices ciblés, <br>de la publicité explicite ou intentionnellement abusifs<br> peuvent être examinés ou supprimés. 
                    <br>L'audit existe pour protéger cette tranquillité. </p> 
                    <p class="about-highlight">Vous n'êtes pas obligé de laisser quoi que ce soit ici,<br> il suffit de naviguer. </p>
                `
                ,
                'jp': `
                    <p>WhisperLocus は公開された匿名のマップです<br>そこでは言葉が交換されるのではなく、配置されます。</p>
                    <p>それは、表現する適切なタイミングを見つけられなかった<br>思考、記憶、感情のために存在します。 </p>
                    <p>すべての投稿は匿名であり、<br>すべての投稿は公開されます。 <br>それらは特定のスペースに固定されており、<br>一意のコードによってのみマークされます。 </p>
                    <p>プロフィール、コメント、返信はありません。</p>
                    <p>対象を絞った危害を含む投稿、<br>露骨な広告、または意図的に虐待的な投稿は<br>審査または削除される場合があります。 
                    <br>監査はこの平穏を守るために存在します。 </p>
                    <p class="about-highlight">ここに何も残す必要はありません。<br> 閲覧するだけで問題ありません。 </p>
                `
                ,
                'es': `
                    <p>WhisperLocus es un mapa público y anónimo<br>donde se colocan palabras, no se intercambian.</p> 
                    <p>Existe para aquellos pensamientos, recuerdos y emociones que nunca han encontrado el momento adecuado para expresarlos. </p> 
                    <p>Cada publicación es anónima,<br>Cada publicación es pública. <br>Están anclados a un espacio específico,<br>marcado únicamente por un código único. </p> 
                    <p>No hay perfiles, ni comentarios, ni respuestas.</p> 
                    <p>Las publicaciones que contengan daño dirigido, <br>publicidad explícita o que sean intencionalmente abusivas<br> pueden revisarse o eliminarse. 
                    <br>La auditoría existe para proteger esta tranquilidad. </p> 
                    <p class="about-highlight">No es necesario que dejes nada aquí,<br> simplemente navegar está bien. </p>
                `
                ,
                'ko': `
                    <p>WhisperLocus는<br>단어가 교환되는 것이 아니라 배치되는 공개 익명 지도입니다.</p> 
                    <p>표현할 적절한 시기를 찾지 못한 <br>생각, 기억, 감정을 위해 존재합니다. </p> 
                    <p>모든 게시물은 익명으로 처리되며<br>모든 게시물은 공개됩니다. <br>특정 공간에 고정되어 있으며<br>고유 코드로만 표시됩니다. </p> 
                    <p>프로필도 없고 댓글도 없고 답글도 없습니다.</p> 
                    <p>해를 끼치는 의도가 포함된 게시물, <br>노골적인 광고 또는 의도적인 욕설이 포함된<br> 게시물은 검토되거나 삭제될 수 있습니다. 
                    <br>감사는 이러한 평온함을 지키기 위해 존재합니다. </p> 
                    <p class="about-highlight">여기에 아무것도 남길 필요가 없습니다.<br> 탐색만 하면 됩니다. </p>
                `
            };

            const userLang = navigator.language || navigator.userLanguage;
            document.getElementById('about-text-container').innerHTML = translations[userLang.startsWith('zh') ? 'zh' : 'en'];

            // --- 2. 交互控制邏輯 ---
            const btnAbout = document.getElementById('btn-about-trigger');
            const aboutPanel = document.getElementById('about-panel');
            const aboutClose = document.getElementById('about-close');
            
            const btnActions = document.getElementById('btn-actions-trigger');
            const actionsPanel = document.getElementById('actions-panel');

            // 顯示 About
            btnAbout.addEventListener('click', () => {
                aboutPanel.classList.add('show');
                actionsPanel.classList.remove('show');
            });

            // 關閉 About
            aboutClose.addEventListener('click', () => aboutPanel.classList.remove('show'));
            aboutPanel.addEventListener('click', (e) => { if(e.target === aboutPanel) aboutPanel.classList.remove('show'); });

            // 切換右側功能選單
            btnActions.addEventListener('click', (e) => {
                e.stopPropagation();
                actionsPanel.classList.toggle('show');
            });

            // 點擊頁面其他地方關閉功能面板
            document.addEventListener('click', (e) => {
                if (!actionsPanel.contains(e.target) && e.target !== btnActions) {
                    actionsPanel.classList.remove('show');
                }
            });

            // --- 3. 搜尋訊息處理 ---
            const msgBox = document.getElementById('code-search-message');
            const urlParams = new URLSearchParams(window.location.search);
            const code = urlParams.get('code');
            if (code) {
                msgBox.textContent = `找到貼文 "${code}"`;
                setTimeout(() => { msgBox.textContent = ""; }, 4000);
            }
        });
    </script>
</body>
</html>